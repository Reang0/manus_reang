<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manus API Client V2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        h1 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .sidebar {
            width: 280px;
            background: #f5f5f5;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 0;
            border-bottom: none;
            font-size: 1em;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .sidebar .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .col {
            flex: 1;
            min-width: 300px;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
        }
        
        .input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: #ffffff;
        }
        
        .input-area textarea {
            border: 2px dashed #3b82f6;
            border-radius: 8px;
            padding: 12px;
        }
        
        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: #3b82f6;
            color: white;
            margin-left: auto;
        }
        
        .message.assistant {
            background: white;
            border: 1px solid #e0e0e0;
        }
        
        .message.assistant.streaming {
            border: 2px solid #3b82f6;
            background: #f0f7ff;
        }
        
        .message.system {
            background: #fff3cd;
            border: 1px solid #ffc107;
            max-width: 100%;
            text-align: center;
            font-size: 13px;
        }
        
        .message .role {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .message .content {
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }
        
        .message .timestamp {
            font-size: 10px;
            opacity: 0.5;
            margin-top: 8px;
            text-align: right;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            gap: 6px;
        }
        
        .status-running {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background: #cce5ff;
            color: #004085;
        }
        
        .file-list {
            list-style: none;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .file-item .file-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        
        .file-item .file-info {
            flex: 1;
        }
        
        .file-item .file-name {
            font-weight: 500;
        }
        
        .file-item .file-id {
            font-size: 12px;
            color: #666;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            background: #ffffff;
            padding: 0 20px;
        }
        
        .tab {
            padding: 14px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .tab:hover {
            background: #f8f9fa;
        }
        
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b6d4fe;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #084298;
        }
        
        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c2c7;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #842029;
        }
        
        .success-box {
            background: #d1e7dd;
            border: 1px solid #badbcc;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #0f5132;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .input-with-history {
            position: relative;
        }
        
        .input-with-history input {
            padding-right: 40px;
        }
        
        .history-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #3b82f6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .history-dropdown.show {
            display: block;
        }
        
        .history-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:hover {
            background: #f0f4ff;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item .value {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .history-item .delete-btn {
            color: #dc3545;
            cursor: pointer;
            padding: 2px 6px;
            margin-left: 8px;
        }
        
        .history-item .delete-btn:hover {
            background: #f8d7da;
            border-radius: 4px;
        }
        
        .history-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #3b82f6;
            font-size: 18px;
            padding: 4px;
        }
        
        .history-toggle:hover {
            background: #f0f4ff;
            border-radius: 4px;
        }
        
        .config-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .config-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .model-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .model-option {
            flex: 1;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }
        
        .model-option:hover {
            border-color: #3b82f6;
            background: #f0f7ff;
        }
        
        .model-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #3b82f6;
        }
        
        .model-option .model-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .model-option .model-desc {
            font-size: 12px;
            color: #666;
        }
        
        #dropZone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #dropZone:hover,
        #dropZone.dragover {
            border-color: #3b82f6;
            background: rgba(102, 126, 234, 0.05);
        }
        
        #dropZone .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .poll-info {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
        
        .streaming-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            font-size: 12px;
            color: #3b82f6;
        }
        
        .streaming-dot {
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            animation: blink 1s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .clear-history-btn {
            font-size: 11px;
            color: #666;
            cursor: pointer;
            padding: 4px 8px;
            margin-top: 4px;
            display: inline-block;
        }
        
        .clear-history-btn:hover {
            color: #dc3545;
        }
        
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .col {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h1>ğŸ¤– Manus-R</h1>
            
            <!-- API é…ç½® -->
            <div class="form-group">
                <label for="apiKey">API Key</label>
                <div class="input-with-history">
                    <input type="password" id="apiKey" placeholder="sk-xxxxxxxx">
                    <span class="history-toggle" onclick="toggleHistory('apiKey')">â–¼</span>
                    <div class="history-dropdown" id="apiKeyHistory"></div>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="toggleApiKey()" style="flex: 1; margin: 0;">ğŸ‘ï¸</button>
                <button class="btn btn-primary" onclick="saveApiKey()" style="flex: 2; margin: 0;">ä¿å­˜ API Key</button>
            </div>
            <div id="apiKeyStatus" class="info-box hidden"></div>
            
            <!-- æ¨¡å‹é€‰æ‹© -->
            <div class="form-group">
                <label>æ¨¡å‹é€‰æ‹©</label>
                <div class="model-option" onclick="selectModel('manus-1.6')" data-model="manus-1.6" style="margin-bottom: 8px;">
                    <div class="model-name">manus-1.6</div>
                    <div class="model-desc">æ ‡å‡†ç‰ˆ</div>
                </div>
                <div class="model-option selected" onclick="selectModel('manus-1.6-max')" data-model="manus-1.6-max" style="margin-bottom: 8px;">
                    <div class="model-name">manus-1.6-max</div>
                    <div class="model-desc">æœ€å¼ºç‰ˆ</div>
                </div>
                <div class="model-option" onclick="selectModel('manus-1.6-lite')" data-model="manus-1.6-lite">
                    <div class="model-name">manus-1.6-lite</div>
                    <div class="model-desc">è½»é‡ç‰ˆ</div>
                </div>
            </div>
            
            <!-- è½®è¯¢è®¾ç½® -->
            <div class="form-group">
                <label>è½®è¯¢è®¾ç½®</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="pollInterval" value="3" min="1" max="30" style="width: 60px;"> 
                    <span>ç§’/æ¬¡</span>
                </div>
                <small style="color: #666; font-size: 11px;">ä»»åŠ¡æ‰§è¡ŒæœŸé—´çš„æŸ¥è¯¢é—´éš”</small>
            </div>
            
            <!-- ä»»åŠ¡ ID -->
            <div class="form-group">
                <label for="taskId">ä»»åŠ¡ ID</label>
                <div class="input-with-history">
                    <input type="text" id="taskId" placeholder="å¤šè½®å¯¹è¯æ—¶å¡«å†™">
                    <span class="history-toggle" onclick="toggleHistory('taskId')">â–¼</span>
                    <div class="history-dropdown" id="taskIdHistory"></div>
                </div>
                <small style="color: #666; font-size: 11px;">ç•™ç©ºåˆ™åˆ›å»ºæ–°å¯¹è¯</small>
            </div>
        </div>
        
        <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- æ ‡ç­¾é¡µ -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('chat')">ğŸ’¬ å¯¹è¯</div>
                <div class="tab" onclick="switchTab('files')">ğŸ“ æ–‡ä»¶ç®¡ç†</div>
                <div class="tab" onclick="switchTab('history')">ğŸ“œ ä»»åŠ¡å†å²</div>
            </div>
            
            <!-- å¯¹è¯æ ‡ç­¾é¡µ -->
            <div id="tab-chat" class="tab-content active">
                <div class="chat-container" id="chatContainer">
                    <div class="info-box">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ Manus-R ï¼è¯·å…ˆé…ç½® API Keyï¼Œç„¶åå¼€å§‹å¯¹è¯ã€‚ğŸ‘‹</div>
                    <div class="info-box">ğŸ‘‹ å½“å‰ä¸ºæµ‹è¯•ç‰ˆ1.0  Byï¼šReang  vxï¼šReang9201ğŸ‘‹</div>
                </div>
                
                <div class="input-area">
                    <!-- é™„ä»¶åˆ—è¡¨ -->
                    <div id="attachmentListContainer" style="margin-bottom: 12px; display: none;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 6px;">ğŸ“ å·²æ·»åŠ çš„é™„ä»¶ï¼š</div>
                        <ul id="attachmentList" class="file-list" style="margin: 0;"></ul>
                    </div>
                    <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯...ï¼ˆShift+Enter æ¢è¡Œï¼ŒEnter å‘é€ï¼‰" onkeydown="handleKeyDown(event)"></textarea>
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">
                            ğŸ“¤ å‘é€æ¶ˆæ¯
                        </button>
                        <button class="btn btn-success" onclick="manualRefresh()" id="refreshBtn" style="display: none;">
                            ğŸ”„ åˆ·æ–°ç»“æœ
                        </button>
                        <button class="btn btn-secondary" onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</button>
                        <button class="btn btn-warning" onclick="stopPolling()" id="stopBtn" style="display: none;">
                            â¹ï¸ åœæ­¢è½®è¯¢
                        </button>
                        <span id="taskStatus"></span>
                    </div>
                </div>
            </div>
            
            <!-- æ–‡ä»¶ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="tab-files" class="tab-content">
                <div style="padding: 20px; overflow-y: auto; flex: 1;">
                    <div class="row">
                        <div class="col">
                            <h3 style="margin-bottom: 16px;">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h3>
                            <div id="dropZone" onclick="document.getElementById('fileInput').click()">
                                <div class="icon">ğŸ“</div>
                                <div>å½“å‰åœ¨çº¿ç‰ˆä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼ï¼ï¼</div>
                                <div style="font-size: 12px; color: #666; margin-top: 8px;">å½“å‰åœ¨çº¿ç‰ˆä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ </div>
                            </div>
                            <input type="file" id="fileInput" style="display: none;" onchange="uploadFile(this.files[0])">
                            <div id="uploadStatus" class="hidden" style="margin-top: 16px;"></div>
                        </div>
                        
                        <div class="col">
                            <h3 style="margin-bottom: 16px;">ğŸ“‚ å·²ä¸Šä¼ æ–‡ä»¶</h3>
                            <button class="btn btn-secondary" onclick="refreshFileList()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                            <ul id="fileList" class="file-list" style="margin-top: 16px;">
                                <li class="file-item" style="color: #666;">ç‚¹å‡»â€œåˆ·æ–°åˆ—è¡¨â€æŸ¥çœ‹å·²ä¸Šä¼ çš„æ–‡ä»¶</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä»»åŠ¡å†å²æ ‡ç­¾é¡µ -->
            <div id="tab-history" class="tab-content">
                <div style="padding: 20px; border-bottom: 1px solid #e0e0e0;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="historyTaskId">è¾“å…¥ä»»åŠ¡ ID æŸ¥çœ‹å†å²</label>
                        <div style="display: flex; gap: 10px;">
                            <div class="input-with-history" style="flex: 1;">
                                <input type="text" id="historyTaskId" placeholder="ä»»åŠ¡ ID">
                                <span class="history-toggle" onclick="toggleHistory('historyTaskId')">â–¼</span>
                                <div class="history-dropdown" id="historyTaskIdHistory"></div>
                            </div>
                            <button class="btn btn-primary" onclick="loadTaskHistory()">ğŸ” æŸ¥è¯¢</button>
                        </div>
                    </div>
                </div>
                
                <div id="historyContainer" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <div class="info-box">è¾“å…¥ä»»åŠ¡ ID æŸ¥çœ‹å®Œæ•´å¯¹è¯å†å²</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentModel = 'manus-1.6-max';
        let currentTaskId = null;
        let uploadedFiles = [];
        let pollingInterval = null;
        let isPolling = false;
        let lastMessageCount = 0;
        let streamingMessageEl = null;
        let currentStreamingId = 0;  // ç”¨äºåŒºåˆ†ä¸åŒçš„æµå¼æ¶ˆæ¯
        
        // å†å²è®°å½•å­˜å‚¨é”®
        const HISTORY_KEYS = {
            apiKey: 'manus_api_keys',
            taskId: 'manus_task_ids',
            historyTaskId: 'manus_task_ids'  // å…±ç”¨ä»»åŠ¡IDå†å²
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä» localStorage åŠ è½½ API Key
            const savedKey = localStorage.getItem('manus_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                showStatus('apiKeyStatus', 'âœ… å·²åŠ è½½ä¿å­˜çš„ API Key', 'success');
            }
            
            // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
            setupDragDrop();
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.input-with-history')) {
                    document.querySelectorAll('.history-dropdown').forEach(d => d.classList.remove('show'));
                }
            });
        });
        
        // ==================== å†å²è®°å½•åŠŸèƒ½ ====================
        
        function getHistory(type) {
            const key = HISTORY_KEYS[type];
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }
        
        function saveToHistory(type, value) {
            if (!value || value.trim() === '') return;
            
            const key = HISTORY_KEYS[type];
            let history = getHistory(type);
            
            // ç§»é™¤é‡å¤é¡¹
            history = history.filter(item => item !== value);
            
            // æ·»åŠ åˆ°å¼€å¤´
            history.unshift(value);
            
            // æœ€å¤šä¿å­˜10æ¡
            if (history.length > 10) {
                history = history.slice(0, 10);
            }
            
            localStorage.setItem(key, JSON.stringify(history));
        }
        
        function removeFromHistory(type, value) {
            const key = HISTORY_KEYS[type];
            let history = getHistory(type);
            history = history.filter(item => item !== value);
            localStorage.setItem(key, JSON.stringify(history));
            renderHistory(type);
        }
        
        function clearHistory(type) {
            const key = HISTORY_KEYS[type];
            localStorage.removeItem(key);
            renderHistory(type);
        }
        
        function toggleHistory(type) {
            const dropdown = document.getElementById(type + 'History');
            const isShow = dropdown.classList.contains('show');
            
            // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
            document.querySelectorAll('.history-dropdown').forEach(d => d.classList.remove('show'));
            
            if (!isShow) {
                renderHistory(type);
                dropdown.classList.add('show');
            }
        }
        
        function renderHistory(type) {
            const dropdown = document.getElementById(type + 'History');
            const history = getHistory(type);
            
            if (history.length === 0) {
                dropdown.innerHTML = '<div class="history-item" style="color: #666; cursor: default;">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            
            dropdown.innerHTML = history.map(value => {
                const displayValue = type === 'apiKey' ? maskApiKey(value) : value;
                return `
                    <div class="history-item">
                        <span class="value" onclick="selectHistory('${type}', '${escapeAttr(value)}')">${escapeHtml(displayValue)}</span>
                        <span class="delete-btn" onclick="event.stopPropagation(); removeFromHistory('${type}', '${escapeAttr(value)}')">âœ•</span>
                    </div>
                `;
            }).join('');
        }
        
        function selectHistory(type, value) {
            // æ ¹æ®ç±»å‹æ‰¾åˆ°å¯¹åº”çš„è¾“å…¥æ¡†
            let inputId = type;
            if (type === 'historyTaskId') {
                inputId = 'historyTaskId';
            }
            
            document.getElementById(inputId).value = value;
            document.querySelectorAll('.history-dropdown').forEach(d => d.classList.remove('show'));
        }
        
        function maskApiKey(key) {
            if (key.length <= 10) return key;
            return key.substring(0, 6) + '****' + key.substring(key.length - 4);
        }
        
        function escapeAttr(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        // ==================== API Key ç›¸å…³ ====================
        
        function toggleApiKey() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey) {
                localStorage.setItem('manus_api_key', apiKey);
                saveToHistory('apiKey', apiKey);
                showStatus('apiKeyStatus', 'âœ… API Key å·²ä¿å­˜', 'success');
            } else {
                showStatus('apiKeyStatus', 'âŒ è¯·è¾“å…¥ API Key', 'error');
            }
        }
        
        function getApiKey() {
            return document.getElementById('apiKey').value.trim();
        }
        
        // ==================== æ ‡ç­¾é¡µåˆ‡æ¢ ====================
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        // ==================== æ¨¡å‹é€‰æ‹© ====================
        
        function selectModel(model) {
            currentModel = model;
            document.querySelectorAll('.model-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.model-option[data-model="${model}"]`).classList.add('selected');
        }
        
        // ==================== å‘é€æ¶ˆæ¯ ====================
        
        async function sendMessage() {
            const apiKey = getApiKey();
            const message = document.getElementById('messageInput').value.trim();
            const taskId = document.getElementById('taskId').value.trim() || currentTaskId;
            
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }
            
            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯');
                return;
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©
            addMessage('user', message);
            document.getElementById('messageInput').value = '';
            
            // ç¦ç”¨å‘é€æŒ‰é’®ï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®å’Œåˆ·æ–°æŒ‰é’®
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span> å‘é€ä¸­...';
            stopBtn.style.display = 'inline-block';
            refreshBtn.style.display = 'inline-block';
            
            // ç«‹å³æ·»åŠ ä¸´æ—¶åé¦ˆæ¶ˆæ¯
            addSystemMessage('â³ æ­£åœ¨å‘é€è¯·æ±‚åˆ° Manus API...');
            
            // é‡ç½®æ¶ˆæ¯è®¡æ•°
            lastMessageCount = 0;
            
            try {
                // æ„å»ºé™„ä»¶
                const attachments = uploadedFiles.map(f => ({
                    type: 'file_id',
                    file_id: f.file_id
                }));
                
                const response = await fetch('/api/create-task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: apiKey,
                        prompt: message,
                        task_id: taskId,
                        agent_profile: currentModel,
                        task_mode: 'agent',
                        attachments: attachments
                    })
                });
                
                const data = await response.json();
                
                // ç§»é™¤ä¸´æ—¶æ¶ˆæ¯
                removeSystemMessages();
                
                if (data.error) {
                    addMessage('assistant', `âŒ é”™è¯¯: ${data.error}`);
                    resetButtons();
                    return;
                }
                
                currentTaskId = data.task_id;
                document.getElementById('taskId').value = currentTaskId;
                
                // ä¿å­˜ä»»åŠ¡IDåˆ°å†å²
                saveToHistory('taskId', currentTaskId);
                
                // æ·»åŠ ä»»åŠ¡åˆ›å»ºæˆåŠŸçš„åé¦ˆ
                addSystemMessage(`âœ… ä»»åŠ¡å·²åˆ›å»º | ID: ${currentTaskId.substring(0, 12)}... | å¼€å§‹æ‰§è¡Œ`);
                
                // åˆ›å»ºæµå¼æ˜¾ç¤ºçš„æ¶ˆæ¯å…ƒç´ 
                createStreamingMessage();
                
                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆæ— è¶…æ—¶é™åˆ¶ï¼‰
                updateTaskStatus('running');
                startPolling(currentTaskId);
                
            } catch (error) {
                removeSystemMessages();
                addMessage('assistant', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
                resetButtons();
            }
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼ˆä¸´æ—¶åé¦ˆï¼‰
        function addSystemMessage(content) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = content;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // ç§»é™¤æ‰€æœ‰ç³»ç»Ÿæ¶ˆæ¯
        function removeSystemMessages() {
            document.querySelectorAll('.message.system').forEach(el => el.remove());
        }
        
        // åˆ›å»ºæµå¼æ˜¾ç¤ºçš„æ¶ˆæ¯å…ƒç´ 
        function createStreamingMessage() {
            // æ¯æ¬¡åˆ›å»ºæ–°çš„æµå¼æ¶ˆæ¯ï¼Œä½¿ç”¨å”¯ä¸€ID
            currentStreamingId++;
            const streamingId = 'streaming-message-' + currentStreamingId;
            
            const container = document.getElementById('chatContainer');
            streamingMessageEl = document.createElement('div');
            streamingMessageEl.className = 'message assistant streaming';
            streamingMessageEl.id = streamingId;
            streamingMessageEl.innerHTML = `
                <div class="role">ğŸ¤– Manus <span class="streaming-indicator"><span class="streaming-dot"></span> æ‰§è¡Œä¸­...</span></div>
                <div class="content">æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...</div>
                <div class="timestamp">${new Date().toLocaleTimeString()}</div>
            `;
            container.appendChild(streamingMessageEl);
            container.scrollTop = container.scrollHeight;
        }
        
        // æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹
        function updateStreamingMessage(content, isComplete = false) {
            // åªæ›´æ–°å½“å‰çš„æµå¼æ¶ˆæ¯
            if (!streamingMessageEl) {
                console.warn('streamingMessageEl ä¸å­˜åœ¨,æ— æ³•æ›´æ–°');
                return;
            }
            
            console.log('æ›´æ–°æµå¼æ¶ˆæ¯:', { contentLength: content?.length, isComplete });
            
            const contentEl = streamingMessageEl.querySelector('.content');
            const timestampEl = streamingMessageEl.querySelector('.timestamp');
            
            if (contentEl) {
                contentEl.innerHTML = escapeHtml(content);
            } else {
                console.warn('contentEl ä¸å­˜åœ¨');
            }
            
            if (timestampEl) {
                timestampEl.textContent = new Date().toLocaleTimeString();
            }
            
            if (isComplete) {
                console.log('æ¶ˆæ¯å®Œæˆ,ç§»é™¤ streaming çŠ¶æ€');
                streamingMessageEl.classList.remove('streaming');
                const roleEl = streamingMessageEl.querySelector('.role');
                if (roleEl) {
                    roleEl.innerHTML = 'ğŸ¤– Manus';
                }
                // å®Œæˆåæ¸…é™¤å¼•ç”¨ï¼Œä¸‹æ¬¡å‘é€ä¼šåˆ›å»ºæ–°çš„
                streamingMessageEl = null;
            }
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const container = document.getElementById('chatContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // æ¸²æŸ“ä»»åŠ¡çš„å®Œæ•´è¾“å‡ºåˆ°èŠå¤©å®¹å™¨
        // ä½¿ç”¨ä¸å†å²æŸ¥è¯¢ç›¸åŒçš„é€»è¾‘,ç¡®ä¿å¯é æ€§
        function renderTaskOutput(output, isError = false) {
            console.log('=== å¼€å§‹ renderTaskOutput (ä½¿ç”¨å†å²æŸ¥è¯¢é€»è¾‘) ===');
            console.log('æ¶ˆæ¯æ•°:', output ? output.length : 0);
            console.log('isError:', isError);
            
            const container = document.getElementById('chatContainer');
            if (!container) {
                console.error('âŒ chatContainer ä¸å­˜åœ¨!');
                return;
            }
            
            if (isError) {
                console.log('ä»»åŠ¡å‡ºé”™,æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯');
                addMessage('assistant', 'âŒ ä»»åŠ¡æ‰§è¡Œå‡ºé”™');
                return;
            }
            
            if (!output || output.length === 0) {
                console.warn('âš ï¸ è¾“å‡ºä¸ºç©º');
                addMessage('assistant', 'âœ… ä»»åŠ¡å·²å®Œæˆ');
                return;
            }
            
            let messageCount = 0;
            
            // ä½¿ç”¨ä¸ loadTaskHistory å®Œå…¨ç›¸åŒçš„é€»è¾‘
            for (const item of output) {
                const role = item.role;
                const content = item.content || [];
                
                console.log('å¤„ç†æ¶ˆæ¯:', { role, contentLength: content.length });
                
                // è·³è¿‡ç”¨æˆ·æ¶ˆæ¯(å› ä¸ºå·²ç»æ˜¾ç¤ºè¿‡äº†)
                if (role === 'user') {
                    console.log('  è·³è¿‡ç”¨æˆ·æ¶ˆæ¯');
                    continue;
                }
                
                // éå† content æ•°ç»„
                for (const c of content) {
                    // æ–‡æœ¬å†…å®¹ - ä½¿ç”¨å†å²æŸ¥è¯¢çš„åˆ¤æ–­é€»è¾‘
                    if (c.type === 'output_text' && c.text) {
                        console.log('  âœ… æ·»åŠ æ–‡æœ¬æ¶ˆæ¯:', c.text.substring(0, 50) + '...');
                        addMessage('assistant', c.text);
                        messageCount++;
                    }
                    // å¦‚æœæ²¡æœ‰ type å­—æ®µ,ä½†æœ‰ text,ä¹Ÿå°è¯•æ·»åŠ 
                    else if (!c.type && c.text) {
                        console.log('  âœ… æ·»åŠ æ–‡æœ¬æ¶ˆæ¯(æ— type):', c.text.substring(0, 50) + '...');
                        addMessage('assistant', c.text);
                        messageCount++;
                    }
                    
                    // é™„ä»¶
                    if (c.fileUrl) {
                        const fileName = c.fileName || 'ä¸‹è½½æ–‡ä»¶';
                        console.log('  âœ… æ·»åŠ é™„ä»¶æ¶ˆæ¯:', fileName);
                        addMessage('assistant', `ğŸ“ é™„ä»¶: ${fileName}\nğŸ”— ${c.fileUrl}`);
                        messageCount++;
                    }
                }
            }
            
            console.log(`âœ… å…±æ·»åŠ äº† ${messageCount} æ¡æ¶ˆæ¯`);
            
            if (messageCount === 0) {
                console.warn('âš ï¸ æ²¡æœ‰æ·»åŠ ä»»ä½•æ¶ˆæ¯,æ˜¾ç¤ºå®Œæˆæç¤º');
                addMessage('assistant', 'âœ… ä»»åŠ¡å·²å®Œæˆ');
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
                console.log('âœ… æ»šåŠ¨åˆ°åº•éƒ¨');
            }, 100);
            
            console.log('=== renderTaskOutput ç»“æŸ ===');
        }

        // åŸºäºå†å²æŸ¥è¯¢çš„è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
        function startPolling(taskId) {
            const log = window.debugLog || console.log;
            log('ğŸ”„ å¼€å§‹è‡ªåŠ¨åˆ·æ–°, Task ID: ' + taskId);
            
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            isPolling = true;
            const apiKey = getApiKey();
            let pollCount = 0;
            let lastMessageCount = 0;  // è®°å½•ä¸Šæ¬¡çš„æ¶ˆæ¯æ•°é‡
            const interval = parseInt(document.getElementById('pollInterval').value) * 1000 || 3000;
            
            // å®šä¹‰åˆ·æ–°å‡½æ•°
            const refreshTaskHistory = async () => {
                if (!isPolling) {
                    log('â¹ï¸ åœæ­¢åˆ·æ–°');
                    clearInterval(pollingInterval);
                    return;
                }
                
                pollCount++;
                log('ğŸ”„ ç¬¬ ' + pollCount + ' æ¬¡åˆ·æ–°...');
                updatePollInfo(pollCount);
                
                try {
                    // ä½¿ç”¨è·å–ä»»åŠ¡è¯¦æƒ…æ¥å£
                    const response = await fetch(`/api/get-task/${taskId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            api_key: apiKey
                        })
                    });
                    
                    if (!response.ok) {
                        log('âŒ åˆ·æ–°å¤±è´¥: ' + response.status);
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        log('âŒ API é”™è¯¯: ' + data.error);
                        return;
                    }
                    
                    const status = data.status;
                    const output = data.output || [];
                    
                    log('ğŸ“Š ä»»åŠ¡çŠ¶æ€: ' + status + ' | æ¶ˆæ¯æ•°: ' + output.length);
                    updateTaskStatus(status, pollCount);
                    
                    // æ£€æµ‹æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
                    const assistantMessages = output.filter(item => item.role === 'assistant');
                    const currentMessageCount = assistantMessages.length;
                    
                    log('ğŸ’¬ åŠ©æ‰‹æ¶ˆæ¯æ•°: ' + currentMessageCount + ' | ä¸Šæ¬¡: ' + lastMessageCount);
                    
                    // å¦‚æœæœ‰æ–°æ¶ˆæ¯,æ›´æ–°æ˜¾ç¤º
                    if (currentMessageCount > lastMessageCount) {
                        log('âœ¨ æ£€æµ‹åˆ°æ–°æ¶ˆæ¯!');
                        
                        // ç§»é™¤æµå¼æ¶ˆæ¯
                        if (streamingMessageEl) {
                            streamingMessageEl.remove();
                            streamingMessageEl = null;
                        }
                        
                        // åªæ·»åŠ æ–°çš„æ¶ˆæ¯
                        for (let i = lastMessageCount; i < currentMessageCount; i++) {
                            const item = assistantMessages[i];
                            const content = item.content || [];
                            
                            for (const c of content) {
                                if (c.type === 'output_text' && c.text) {
                                    log('â• æ·»åŠ æ–°æ¶ˆæ¯: ' + c.text.substring(0, 30) + '...');
                                    addMessage('assistant', c.text);
                                }
                                
                                if (c.fileUrl) {
                                    const fileName = c.fileName || 'ä¸‹è½½æ–‡ä»¶';
                                    addMessage('assistant', `ğŸ“ é™„ä»¶: ${fileName}\nğŸ”— ${c.fileUrl}`);
                                }
                            }
                        }
                        
                        lastMessageCount = currentMessageCount;
                    }
                    
                    // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
                    if (status === 'completed' || status === 'failed' || status === 'error') {
                        log('âœ… ä»»åŠ¡å·²å®Œæˆ, çŠ¶æ€: ' + status);
                        stopPolling();
                        removeSystemMessages();
                        
                        // ç§»é™¤æµå¼æ¶ˆæ¯
                        if (streamingMessageEl) {
                            streamingMessageEl.remove();
                            streamingMessageEl = null;
                        }
                        
                        // å¦‚æœè¿˜æ²¡æœ‰æ˜¾ç¤ºä»»ä½•æ¶ˆæ¯,æ˜¾ç¤ºå®Œæˆæç¤º
                        if (currentMessageCount === 0) {
                            addMessage('assistant', 'âœ… ä»»åŠ¡å·²å®Œæˆ');
                        }
                        
                        resetButtons();
                    }
                    
                } catch (error) {
                    log('âŒ åˆ·æ–°å‡ºé”™: ' + error);
                }
            };
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            log('âš¡ ç«‹å³æ‰§è¡Œç¬¬ä¸€æ¬¡åˆ·æ–°...');
            refreshTaskHistory().catch(err => log('âŒ é¦–æ¬¡åˆ·æ–°å¤±è´¥: ' + err));
            
            // è®¾ç½®å®šæ—¶åˆ·æ–°
            log('â° è®¾ç½®å®šæ—¶åˆ·æ–°,é—´éš” ' + interval + 'ms');
            pollingInterval = setInterval(() => {
                log('â° å®šæ—¶å™¨è§¦å‘');
                refreshTaskHistory().catch(err => log('âŒ å®šæ—¶åˆ·æ–°å¤±è´¥: ' + err));
            }, interval);
            
            log('âœ… startPolling å®Œæˆ, å®šæ—¶å™¨ID: ' + pollingInterval);
        }
        
        // åœæ­¢è½®è¯¢
        function stopPolling() {
            isPolling = false;
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            resetButtons();
            const pollInfo = document.getElementById('pollInfo');
            if (pollInfo) {
                pollInfo.textContent = '';
}

        }
        
        // æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½
        async function manualRefresh() {
            console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°...');
            
            const taskId = currentTaskId || document.getElementById('taskId').value.trim();
            const apiKey = getApiKey();
            
            if (!taskId) {
                alert('è¯·å…ˆå‘é€æ¶ˆæ¯æˆ–è¾“å…¥ä»»åŠ¡ ID');
                return;
            }
            
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }
            
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="loading"></span> åˆ·æ–°ä¸­...';
            
            try {
                const response = await fetch(`/api/get-task/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        api_key: apiKey
                    })
                });
                
                if (!response.ok) {
                    alert('åˆ·æ–°å¤±è´¥: ' + response.status);
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    alert('API é”™è¯¯: ' + data.error);
                    return;
                }
                
                console.log('ğŸ“Š ä»»åŠ¡çŠ¶æ€:', data.status);
                console.log('ğŸ’¬ æ¶ˆæ¯æ•°:', data.output?.length);
                
                // æ¸…ç©ºå½“å‰å¯¹è¯ä¸­çš„åŠ©æ‰‹æ¶ˆæ¯
                const container = document.getElementById('chatContainer');
                const assistantMessages = container.querySelectorAll('.message.assistant');
                assistantMessages.forEach(msg => msg.remove());
                
                // ç§»é™¤æµå¼æ¶ˆæ¯
                if (streamingMessageEl) {
                    streamingMessageEl.remove();
                    streamingMessageEl = null;
                }
                
                // ç§»é™¤ç³»ç»Ÿæ¶ˆæ¯
                removeSystemMessages();
                
                // æ·»åŠ æ‰€æœ‰åŠ©æ‰‹æ¶ˆæ¯
                const output = data.output || [];
                let messageCount = 0;
                
                for (const item of output) {
                    if (item.role === 'assistant') {
                        const content = item.content || [];
                        
                        for (const c of content) {
                            if (c.type === 'output_text' && c.text) {
                                addMessage('assistant', c.text);
                                messageCount++;
                            }
                            
                            if (c.fileUrl) {
                                const fileName = c.fileName || 'ä¸‹è½½æ–‡ä»¶';
                                addMessage('assistant', `ğŸ“ é™„ä»¶: ${fileName}\nğŸ”— ${c.fileUrl}`);
                                messageCount++;
                            }
                        }
                    }
                }
                
                console.log(`âœ… åˆ·æ–°å®Œæˆ, æ·»åŠ äº† ${messageCount} æ¡æ¶ˆæ¯`);
                
                if (messageCount === 0) {
                    addMessage('assistant', 'âœ… ä»»åŠ¡å·²å®Œæˆï¼Œä½†æš‚æ— å›å¤å†…å®¹');
                }
                
                // æ›´æ–°ä»»åŠ¡çŠ¶æ€
                updateTaskStatus(data.status);
                
            } catch (error) {
                console.error('âŒ åˆ·æ–°å‡ºé”™:', error);
                alert('åˆ·æ–°å¤±è´¥: ' + error.message);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        }
        
        // æ›´æ–°è½®è¯¢ä¿¡æ¯
        function updatePollInfo(count, extra = '') {
            const pollInfo = document.getElementById('pollInfo');
            if (pollInfo) {
                const interval = document.getElementById('pollInterval').value;
                pollInfo.textContent = `è½®è¯¢ #${count} | é—´éš” ${interval}s ${extra}`;
            }
        }
        
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        function resetButtons() {
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            sendBtn.disabled = false;
            sendBtn.innerHTML = 'ğŸ“¤ å‘é€æ¶ˆæ¯';
            stopBtn.style.display = 'none';
            refreshBtn.style.display = 'none';
        }
        
        // æ›´æ–°ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º
        function updateTaskStatus(status, count = 0) {
            const statusEl = document.getElementById('taskStatus');
            if (!statusEl) return;
            
            let html = '';
            
            switch (status) {
                case 'running':
                    html = `<span class="status-badge status-running"><span class="loading"></span> æ‰§è¡Œä¸­</span>`;
                    break;
                case 'completed':
                    html = '<span class="status-badge status-completed">âœ… å·²å®Œæˆ</span>';
                    break;
                case 'error':
                    html = '<span class="status-badge status-error">âŒ é”™è¯¯</span>';
                    break;
                case 'pending':
                    html = '<span class="status-badge status-pending">â¸ï¸ ç­‰å¾…è¾“å…¥</span>';
                    break;
                default:
                    html = `<span class="status-badge">${status}</span>`;
            }
            
            statusEl.innerHTML = html;
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const roleText = role === 'user' ? 'ğŸ‘¤ æ‚¨' : 'ğŸ¤– Manus';
            const timestamp = new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="role">${roleText}</div>
                <div class="content">${escapeHtml(content)}</div>
                <div class="timestamp">${timestamp}</div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            stopPolling();
            document.getElementById('chatContainer').innerHTML = '<div class="info-box">ğŸ‘‹ å¯¹è¯å·²æ¸…ç©ºï¼Œå¼€å§‹æ–°çš„å¯¹è¯å§ï¼</div>';
            currentTaskId = null;
            document.getElementById('taskId').value = '';
            uploadedFiles = [];
            updateAttachmentList();
            lastMessageCount = 0;
            streamingMessageEl = null;
            updateTaskStatus('');
        }
        
        // é”®ç›˜äº‹ä»¶
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // ==================== æ–‡ä»¶ä¸Šä¼  ====================
        
        function setupDragDrop() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFile(files[0]);
                }
            });
        }
        
        async function uploadFile(file) {
            const apiKey = getApiKey();
            
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }
            
            const statusEl = document.getElementById('uploadStatus');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<div class="info-box"><span class="loading"></span> æ­£åœ¨ä¸Šä¼ ...</div>';
            
            try {
                const formData = new FormData();
                formData.append('api_key', apiKey);
                formData.append('file', file);
                
                const response = await fetch('/api/upload-file', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    statusEl.innerHTML = `<div class="error-box">âŒ ä¸Šä¼ å¤±è´¥: ${data.error}</div>`;
                } else {
                    statusEl.innerHTML = `<div class="success-box">âœ… ä¸Šä¼ æˆåŠŸï¼æ–‡ä»¶å·²æ·»åŠ åˆ°å¯¹è¯é™„ä»¶</div>`;
                    
                    // æ·»åŠ åˆ°å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
                    uploadedFiles.push({
                        file_id: data.file_id,
                        filename: data.filename
                    });
                    updateAttachmentList();
                    refreshFileList();
                    
                    // è‡ªåŠ¨åˆ‡æ¢åˆ°å¯¹è¯æ ‡ç­¾é¡µ
                    setTimeout(() => {
                        switchTab('chat');
                    }, 1000);
                }
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-box">âŒ ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ›´æ–°é™„ä»¶åˆ—è¡¨
        function updateAttachmentList() {
            const list = document.getElementById('attachmentList');
            const container = document.getElementById('attachmentListContainer');
            
            // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            if (!list) {
                console.warn('attachmentList element not found');
                return;
            }
            
            if (uploadedFiles.length === 0) {
                // æ²¡æœ‰é™„ä»¶æ—¶éšè—å®¹å™¨
                if (container) {
                    container.style.display = 'none';
                }
                list.innerHTML = '';
            } else {
                // æœ‰é™„ä»¶æ—¶æ˜¾ç¤ºå®¹å™¨
                if (container) {
                    container.style.display = 'block';
                }
                list.innerHTML = uploadedFiles.map((f, i) => `
                    <li class="file-item">
                        <span class="file-icon">ğŸ“„</span>
                        <div class="file-info">
                            <div class="file-name">${escapeHtml(f.filename)}</div>
                            <div class="file-id" style="font-size: 11px;">${f.file_id}</div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeAttachment(${i})">ç§»é™¤</button>
                    </li>
                `).join('');
            }
        }
        
        function removeAttachment(index) {
            uploadedFiles.splice(index, 1);
            updateAttachmentList();
        }
        
        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        async function refreshFileList() {
            const apiKey = getApiKey();
            
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }
            
            const list = document.getElementById('fileList');
            list.innerHTML = '<li class="file-item"><span class="loading"></span> åŠ è½½ä¸­...</li>';
            
            try {
                const response = await fetch('/api/list-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: apiKey })
                });
                
                const data = await response.json();
                const files = data.data || [];
                
                if (files.length === 0) {
                    list.innerHTML = '<li class="file-item" style="color: #666;">æš‚æ— æ–‡ä»¶</li>';
                } else {
                    list.innerHTML = files.map(f => `
                        <li class="file-item">
                            <span class="file-icon">ğŸ“„</span>
                            <div class="file-info">
                                <div class="file-name">${escapeHtml(f.filename)}</div>
                                <div class="file-id">${f.id} | ${f.status}</div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="useFile('${f.id}', '${escapeHtml(f.filename)}')">ä½¿ç”¨</button>
                        </li>
                    `).join('');
                }
                
            } catch (error) {
                list.innerHTML = `<li class="file-item" style="color: red;">åŠ è½½å¤±è´¥: ${error.message}</li>`;
            }
        }
        
        function useFile(fileId, filename) {
            // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
            if (uploadedFiles.some(f => f.file_id === fileId)) {
                alert('è¯¥æ–‡ä»¶å·²æ·»åŠ ');
                return;
            }
            
            uploadedFiles.push({ file_id: fileId, filename: filename });
            updateAttachmentList();
            switchTab('chat');
        }
        
        // ==================== ä»»åŠ¡å†å² ====================
        
        async function loadTaskHistory() {
            const apiKey = getApiKey();
            const taskId = document.getElementById('historyTaskId').value.trim();
            
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }
            
            if (!taskId) {
                alert('è¯·è¾“å…¥ä»»åŠ¡ ID');
                return;
            }
            
            // ä¿å­˜åˆ°å†å²
            saveToHistory('taskId', taskId);
            
            const container = document.getElementById('historyContainer');
            container.innerHTML = '<div class="info-box"><span class="loading"></span> åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`/api/get-task/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: apiKey })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    container.innerHTML = `<div class="error-box">âŒ é”™è¯¯: ${data.error}</div>`;
                    return;
                }
                
                const output = data.output || [];
                
                if (output.length === 0) {
                    container.innerHTML = '<div class="info-box">è¯¥ä»»åŠ¡æš‚æ— å¯¹è¯è®°å½•</div>';
                    return;
                }
                
                let html = `
                    <div class="info-box">
                        <strong>ä»»åŠ¡ ID:</strong> ${data.id}<br>
                        <strong>çŠ¶æ€:</strong> ${data.status}<br>
                        <strong>æ¨¡å‹:</strong> ${data.model || 'N/A'}<br>
                        <strong>æ¶ˆæ¯æ•°:</strong> ${output.length}
                    </div>
                `;
                
                for (const item of output) {
                    const role = item.role;
                    const content = item.content || [];
                    
                    for (const c of content) {
                        if (c.type === 'output_text' && c.text) {
                            const roleText = role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– åŠ©æ‰‹';
                            html += `
                                <div class="message ${role}">
                                    <div class="role">${roleText}</div>
                                    <div class="content">${escapeHtml(c.text)}</div>
                                </div>
                            `;
                        }
                        
                        if (c.fileUrl) {
                            html += `
                                <div class="message assistant">
                                    <div class="role">ğŸ“ é™„ä»¶</div>
                                    <div class="content">
                                        <a href="${c.fileUrl}" target="_blank">${escapeHtml(c.fileName || 'ä¸‹è½½æ–‡ä»¶')}</a>
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<div class="error-box">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // ==================== å·¥å…·å‡½æ•° ====================
        
        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.classList.remove('hidden', 'info-box', 'error-box', 'success-box');
            el.classList.add(type === 'error' ? 'error-box' : type === 'success' ? 'success-box' : 'info-box');
            el.textContent = message;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ 
            setupDragDrop();
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥äº‹ä»¶
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (this.files && this.files.length > 0) {
                        uploadFile(this.files[0]);
                    }
                });
            }
        });
    </script>
</body>
</html>
